require('dotenv').config();
const { Telegraf, Markup } = require('telegraf');

const bot = new Telegraf(process.env.BOT_TOKEN);
const chatId = "-1002499532353"; // ID –≥—Ä—É–ø–ø—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

// –•—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏
const userStates = {};

// –•—Ä–∞–Ω–∏–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏, –≤–º–µ—Å—Ç–µ —Å message_id (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø—ã)
const submittedRequests = {};

// –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
const mainMenu = Markup.keyboard([
    ["üì© –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É", "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É"],
    ["‚ÑπÔ∏è –ò–Ω—Ñ–æ", "üí¨ –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏"]
]).resize();

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.start((ctx) => {
    ctx.reply("üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", mainMenu);
});

// –ö–æ–º–∞–Ω–¥–∞ /menu - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
bot.command("menu", (ctx) => {
    ctx.reply("üìã –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", mainMenu);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ ‚ÑπÔ∏è –ò–Ω—Ñ–æ
bot.hears("‚ÑπÔ∏è –ò–Ω—Ñ–æ", (ctx) => {
    ctx.reply(
        "‚ÑπÔ∏è *–ú—ã –ø–æ–º–æ–≥–∞–µ–º –≤–∞–º —Å –≤—ã–≤–æ–∑–æ–º –º—É—Å–æ—Ä–∞.*\n\n" +
        "‚úÖ *–ß—Ç–æ –º—ã –¥–µ–ª–∞–µ–º:*\n" +
        "- –ë—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ –≤—ã–≤–æ–∑–∏–º –º—É—Å–æ—Ä —Å –≤–∞—à–µ–≥–æ –∞–¥—Ä–µ—Å–∞.\n" +
        "- –†–∞–±–æ—Ç–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, –±–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö.\n" +
        "- –°–æ–±–ª—é–¥–∞–µ–º –≤—Å–µ —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω–æ—Ä–º—ã.\n" +
        "- –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –∑–∞—è–≤–∫–∏.\n\n" +
        "üöõ *–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É?*\n" +
        "1Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ \"üì© –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É\".\n" +
        "2Ô∏è‚É£ –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∞–¥—Ä–µ—Å –∏ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–≤–æ–∑–∞ –º—É—Å–æ—Ä–∞.\n" +
        "3Ô∏è‚É£ –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.\n\n" +
        "‚è∞ *–í–∞–∂–Ω–æ!* –ó–∞—è–≤–∫–∞ –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø–æ–¥–∞—á–∏.\n\n" +
        "üí¨ *–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞–∂–º–∏—Ç–µ \"üí¨ –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏\".*",
        { parse_mode: "Markdown" }
    );
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ üí¨ –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
bot.hears("üí¨ –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏", (ctx) => {
    ctx.reply(
        "üí¨ *–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–µ–π —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏:*\n\n" +
        "üìû *–¢–µ–ª–µ—Ñ–æ–Ω:* +1234567890\n" +
        "üìß *Email:* support@cleanservice.com\n" +
        "üì≤ *Telegram:* @SupportChat\n\n" +
        "–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º 24/7 –∏ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å –≤–∞–º! üòä",
        { parse_mode: "Markdown" }
    );
});

// –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏
bot.hears("üì© –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É", (ctx) => {
    const userId = ctx.from.id;
    userStates[userId] = { step: "street" }; // –ù–∞—á–∏–Ω–∞–µ–º —Å —É–ª–∏—Ü—ã
    ctx.reply("üìç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —É–ª–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –õ–µ–Ω–∏–Ω–∞):");
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É"
bot.hears("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É", (ctx) => {
    const userId = ctx.from.id;

    // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    if (userStates[userId]) {
        delete userStates[userId];
        ctx.reply("‚úÖ –í–∞—à–∞ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.");
        return;
    }

    // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –≥—Ä—É–ø–ø—É
    if (submittedRequests[userId]) {
        const requestData = submittedRequests[userId];
        delete submittedRequests[userId];

        ctx.reply("‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞.");

        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞—è–≤–∫–æ–π –∏–∑ –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ —Ö–æ—Ç–∏–º —É–¥–∞–ª—è—Ç—å –∏–º–µ–Ω–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        if (requestData.messageId) {
            bot.telegram.deleteMessage(chatId, requestData.messageId)
                .then(() => {
                    // –û–ø–æ–≤–µ—â–∞–µ–º –≥—Ä—É–ø–ø—É –æ —Ç–æ–º, —á—Ç–æ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞
                    bot.telegram.sendMessage(
                        chatId,
                        `‚ùå *–û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏*\n\nüë§ –ö–ª–∏–µ–Ω—Ç: ${ctx.from.first_name} (@${ctx.from.username || "–Ω–µ—Ç –ª–æ–≥–∏–Ω–∞"})\n\n*–û—Ç–º–µ–Ω–µ–Ω–∞ –∑–∞—è–≤–∫–∞:*\nüìç –£–ª–∏—Ü–∞: ${requestData.street}\nüè¢ –î–æ–º: ${requestData.house}\nüè† –ö–≤–∞—Ä—Ç–∏—Ä–∞: ${requestData.apartment}\n‚è∞ –í—Ä–µ–º—è: ${requestData.time}\n\n‚úÖ –ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∫–∞–Ω–∞–ª–∞.`,
                        { parse_mode: "Markdown" }
                    );
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø—ã:", error);
                    bot.telegram.sendMessage(chatId, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –∏–∑ –≥—Ä—É–ø–ø—ã.");
                });
        } else {
            // –ï—Å–ª–∏ messageId –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–ø–æ–≤–µ—â–∞–µ–º –≥—Ä—É–ø–ø—É
            bot.telegram.sendMessage(
                chatId,
                `‚ùå *–û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏*\n\nüë§ –ö–ª–∏–µ–Ω—Ç: ${ctx.from.first_name} (@${ctx.from.username || "–Ω–µ—Ç –ª–æ–≥–∏–Ω–∞"})\n\n*–û—Ç–º–µ–Ω–µ–Ω–∞ –∑–∞—è–≤–∫–∞:*\nüìç –£–ª–∏—Ü–∞: ${requestData.street}\nüè¢ –î–æ–º: ${requestData.house}\nüè† –ö–≤–∞—Ä—Ç–∏—Ä–∞: ${requestData.apartment}\n‚è∞ –í—Ä–µ–º—è: ${requestData.time}\n\n‚úÖ –ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∫–∞–Ω–∞–ª–∞.`,
                { parse_mode: "Markdown" }
            );
        }
        return;
    }

    // –ï—Å–ª–∏ –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã –Ω–µ—Ç
    ctx.reply("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã.");
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏
bot.on("text", (ctx) => {
    const userId = ctx.from.id;
    const message = ctx.message.text;
    
    if (userStates[userId]) {
        switch (userStates[userId].step) {
            case "street":
                userStates[userId].street = message;
                userStates[userId].step = "house";
                ctx.reply("üè¢ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10):");
                break;

            case "house":
                userStates[userId].house = message;
                userStates[userId].step = "apartment";
                ctx.reply("üè† –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã (–µ—Å–ª–∏ —á–∞—Å—Ç–Ω—ã–π –¥–æ–º, –Ω–∞–ø–∏—à–∏—Ç–µ '–Ω–µ—Ç'):");  
                break;

            case "apartment":
                userStates[userId].apartment = message;
                userStates[userId].step = "time";
                ctx.reply(
                    "‚è∞ –í–≤–µ–¥–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–≤–æ–∑–∞ –º—É—Å–æ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä, 18:00):\n\n" +
                    "‚ö†Ô∏è *–ó–∞—è–≤–∫–∞ –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø–æ–¥–∞—á–∏!*", // <-- –û—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    { parse_mode: "Markdown" }
                );
                break;

            case "time":
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ (–ß–ß:–ú–ú)
                const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
                if (!timeRegex.test(message)) {
                    ctx.reply("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä, 18:00)");
                    return;
                }

                userStates[userId].time = message;
                // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
                const requestData = {
                    street: userStates[userId].street,
                    house: userStates[userId].house,
                    apartment: userStates[userId].apartment,
                    time: userStates[userId].time
                };

                // –°–æ–æ–±—â–µ–Ω–∏–µ –î–õ–Ø –ì–†–£–ü–ü–´ (–±–µ–∑ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ 30 –º–∏–Ω—É—Ç!)
                const requestText = `üìù *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞*\nüë§ –ö–ª–∏–µ–Ω—Ç: ${ctx.from.first_name} (@${ctx.from.username || "–Ω–µ—Ç –ª–æ–≥–∏–Ω–∞"})\nüìç –ê–¥—Ä–µ—Å:\n   ‚Ä¢ –£–ª–∏—Ü–∞: ${requestData.street}\n   ‚Ä¢ –î–æ–º: ${requestData.house}\n   ‚Ä¢ –ö–≤–∞—Ä—Ç–∏—Ä–∞: ${requestData.apartment}\n‚è∞ –í—Ä–µ–º—è: ${requestData.time}\n‚úÖ –°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è`;

                // –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º)
                ctx.reply(
                    "‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞—à–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º. üöõ\n\n" +
                    "‚ö†Ô∏è *–ó–∞—è–≤–∫–∞ –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç!*",
                    { parse_mode: "Markdown" }
                );

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É –≤ –≥—Ä—É–ø–ø—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º message_id
                bot.telegram.sendMessage(chatId, requestText, { parse_mode: "Markdown" })
                    .then((sentMessage) => {
                        submittedRequests[userId] = {
                            ...requestData,
                            messageId: sentMessage.message_id
                        };
                    })
                    .catch((error) => {
                        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏ –≤ –≥—Ä—É–ø–ø—É:", error);
                    });

                // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                delete userStates[userId];
                break;
        }
    }
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
bot.launch();
console.log("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...");
